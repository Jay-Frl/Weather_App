<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Weather App</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            background: linear-gradient(to bottom, #1e3a8a, #60a5fa);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            font-family: Arial, sans-serif;
        }
        .weather-card {
            background: rgba(255, 255, 255, 0.9);
            border-radius: 1rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            padding: 2rem;
            width: 100%;
            max-width: 400px;
            margin: 1rem;
        }
        .weather-emoji {
            font-size: 3rem;
        }
        @media (max-width: 640px) {
            .weather-card {
                padding: 1.5rem;
                margin: 0.5rem;
            }
            .weather-emoji {
                font-size: 2.5rem;
            }
        }
    </style>
</head>
<body>
    <div class="weather-card">
        <h1 class="text-2xl font-bold text-center text-gray-800 mb-4">Weather App</h1>
        <div id="weather-info" class="text-center">
            <p id="location" class="text-lg font-semibold text-gray-700">Fetching location...</p>
            <p id="temperature" class="text-4xl font-bold text-gray-800 mt-2">-- Â°C</p>
            <p id="weather-emoji" class="weather-emoji">â›…</p>
            <p id="description" class="text-lg text-gray-600 capitalize mt-2">--</p>
            <div class="mt-4 grid grid-cols-2 gap-4">
                <div>
                    <p class="text-sm text-gray-500">Humidity</p>
                    <p id="humidity" class="text-lg font-semibold text-gray-700">-- %</p>
                </div>
                <div>
                    <p class="text-sm text-gray-500">Wind Speed</p>
                    <p id="wind-speed" class="text-lg font-semibold text-gray-700">-- m/s</p>
                </div>
                <div>
                    <p class="text-sm text-gray-500">Feels Like</p>
                    <p id="feels-like" class="text-lg font-semibold text-gray-700">-- Â°C</p>
                </div>
                <div>
                    <p class="text-sm text-gray-500">Pressure</p>
                    <p id="pressure" class="text-lg font-semibold text-gray-700">-- hPa</p>
                </div>
            </div>
            <p id="error" class="text-red-500 mt-4 hidden"></p>
        </div>
    </div>

    <!-- Chat Button and Modal -->
    <button id="open-chat" class="fixed bottom-6 right-6 z-40 bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-full shadow-lg transition-all duration-300 focus:outline-none focus:ring-4 focus:ring-blue-300">
        ðŸ’¬ Chat
    </button>
    <div id="chat-modal" class="fixed inset-0 z-50 flex items-end sm:items-center justify-center bg-black bg-opacity-40 hidden">
        <div class="bg-white rounded-t-2xl sm:rounded-2xl shadow-2xl w-full max-w-md mx-auto flex flex-col h-[70vh] sm:h-[70vh]">
            <div class="flex items-center justify-between p-4 border-b">
                <h2 class="text-lg font-semibold text-gray-800">AI Chatbot</h2>
                <button id="close-chat" class="text-gray-400 hover:text-gray-800 text-2xl leading-none">&times;</button>
            </div>
            <div id="chat-messages" class="flex-1 overflow-y-auto p-4 space-y-4 bg-gray-50">
                <!-- Messages will appear here -->
            </div>
            <form id="chat-form" class="flex items-center border-t p-3 bg-white">
                <input id="chat-input" type="text" placeholder="Type your message..." class="flex-1 border rounded-full px-4 py-2 mr-2 focus:outline-none focus:ring-2 focus:ring-blue-300" required autocomplete="off" />
                <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white rounded-full px-5 py-2 font-semibold shadow-md transition-all duration-200">Send</button>
            </form>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const apiKey = '97cd60fb0dd1f6913fe03c56d3cbec20'; // Replace with your OpenWeatherMap API key
            const weatherInfo = document.getElementById('weather-info');
            const locationEl = document.getElementById('location');
            const temperatureEl = document.getElementById('temperature');
            const weatherEmojiEl = document.getElementById('weather-emoji');
            const descriptionEl = document.getElementById('description');
            const humidityEl = document.getElementById('humidity');
            const windSpeedEl = document.getElementById('wind-speed');
            const errorEl = document.getElementById('error');
            const feelsLikeEl = document.getElementById('feels-like');
            const pressureEl = document.getElementById('pressure');

            const weatherEmojis = {
                'Clear': 'â˜€ï¸',
                'Clouds': 'â˜ï¸',
                'Rain': 'ðŸŒ§ï¸',
                'Drizzle': 'ðŸŒ¦ï¸',
                'Thunderstorm': 'â›ˆï¸',
                'Snow': 'â„ï¸',
                'Mist': 'ðŸŒ«ï¸',
                'Fog': 'ðŸŒ«ï¸',
                'Haze': 'ðŸŒ«ï¸'
            };

            function showError(message) {
                errorEl.textContent = message;
                errorEl.classList.remove('hidden');
                weatherInfo.style.opacity = '0.6';
            }

            function clearError() {
                errorEl.textContent = '';
                errorEl.classList.add('hidden');
                weatherInfo.style.opacity = '1';
            }

            function getWeatherEmoji(weather) {
                return weatherEmojis[weather] || 'â›…';
            }

            // Track current temperature for prompt injection
            let currentTemperature = '-- Â°C';
            function updateWeather(data) {
                clearError();
                locationEl.textContent = data.name;
                temperatureEl.textContent = `${Math.round(data.main.temp)} Â°C`;
                weatherEmojiEl.textContent = getWeatherEmoji(data.weather[0].main);
                descriptionEl.textContent = data.weather[0].description;
                humidityEl.textContent = `${data.main.humidity} %`;
                windSpeedEl.textContent = `${data.wind.speed} m/s`;
                feelsLikeEl.textContent = `${Math.round(data.main.feels_like)} Â°C`;
                pressureEl.textContent = `${data.main.pressure} hPa`;
                currentTemperature = `${Math.round(data.main.temp)} Â°C`;
            }

            async function fetchWeather(lat, lon) {
                try {
                    const response = await fetch(
                        `https://api.openweathermap.org/data/2.5/weather?lat=${lat}&lon=${lon}&units=metric&appid=${apiKey}`
                    );
                    if (!response.ok) {
                        throw new Error('Failed to fetch weather data');
                    }
                    const data = await response.json();
                    updateWeather(data);
                } catch (error) {
                    showError('Unable to fetch weather data. Please try again later.');
                }
            }

            function getLocation() {
                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(
                        (position) => {
                            const { latitude, longitude } = position.coords;
                            fetchWeather(latitude, longitude);
                        },
                        (error) => {
                            showError('Location access denied. Please enable location services.');
                        }
                    );
                } else {
                    showError('Geolocation is not supported by your browser.');
                }
            }

            getLocation();

            // Chatbot functionality
            const openChatBtn = document.getElementById('open-chat');
            const chatModal = document.getElementById('chat-modal');
            const closeChatBtn = document.getElementById('close-chat');
            const chatForm = document.getElementById('chat-form');
            const chatInput = document.getElementById('chat-input');
            const chatMessages = document.getElementById('chat-messages');

            // Open modal
            openChatBtn.addEventListener('click', () => {
                chatModal.classList.remove('hidden');
                setTimeout(() => {
                    chatInput.focus();
                }, 200);
            });
            // Close modal
            closeChatBtn.addEventListener('click', () => {
                chatModal.classList.add('hidden');
            });
            // Close on outside click
            chatModal.addEventListener('click', (e) => {
                if (e.target === chatModal) {
                    chatModal.classList.add('hidden');
                }
            });

            // Gemini API Key (replace with your actual key)
            const GEMINI_API_KEY = 'xxxxxxxxxxxxx';

            // Send message
            chatForm.addEventListener('submit', async function(e) {
                e.preventDefault();
                const message = chatInput.value.trim();
                if (!message) return;
                addMessage('user', message);
                chatInput.value = '';
                showTypingIndicator();
                try {
                    const aiReply = await fetchGeminiReply(message);
                    removeTypingIndicator();
                    addMessage('ai', aiReply);
                } catch (err) {
                    removeTypingIndicator();
                    addMessage('ai', 'Sorry, I could not get a response.');
                }
            });

            // Add message to chat
            function addMessage(sender, text) {
                if (sender === 'ai') {
                    text = formatAIResponse(text);
                }
                const msgDiv = document.createElement('div');
                msgDiv.className = sender === 'user' ? 'flex justify-end' : 'flex justify-start';
                msgDiv.innerHTML = `<div class="max-w-xs px-4 py-2 rounded-2xl shadow text-sm ${sender === 'user' ? 'bg-blue-600 text-white rounded-br-none' : 'bg-gray-200 text-gray-900 rounded-bl-none'}">${text}</div>`;
                chatMessages.appendChild(msgDiv);
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }

            // Format Gemini AI response for clean, short, step-by-step output
            function formatAIResponse(rawText) {
                // Remove markdown, excessive whitespace, and long lists
                let text = rawText
                    .replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>') // bold
                    .replace(/\* ([^\n]+)/g, '<br>â€¢ $1') // bullets
                    .replace(/\n{2,}/g, '<br>') // double line breaks
                    .replace(/\n/g, ' ') // single line break to space
                    .replace(/\s{2,}/g, ' '); // collapse spaces

                // Extract up to 3 bullets if present
                let bulletMatch = text.match(/â€¢ /g);
                if (bulletMatch && bulletMatch.length > 0) {
                    let bullets = text.split('â€¢ ');
                    let intro = bullets.shift(); // text before first bullet
                    let selected = bullets.slice(0, 3).map(b => 'â€¢ ' + b.trim());
                    let result = intro.trim() + '<br>' + selected.join('<br>');
                    if (bullets.length > 3) result += '<br>...';
                    return result.trim();
                }

                // If no bullets, return up to 2 full sentences
                let sentences = text.split('. ');
                if (sentences.length > 1) {
                    let result = sentences.slice(0, 2).join('. ') + '.';
                    if (sentences.length > 2) result += ' ...';
                    return result.trim();
                }

                // Otherwise, just return the cleaned text
                return text.trim();
            }

            // Typing indicator
            let typingDiv = null;
            function showTypingIndicator() {
                removeTypingIndicator();
                typingDiv = document.createElement('div');
                typingDiv.className = 'flex justify-start';
                typingDiv.innerHTML = `<div class="max-w-xs px-4 py-2 rounded-2xl shadow text-sm bg-gray-200 text-gray-900 rounded-bl-none flex items-center"><span class="animate-bounce inline-block mr-2 w-2 h-2 bg-blue-400 rounded-full"></span><span class="animate-bounce inline-block mr-2 w-2 h-2 bg-blue-400 rounded-full delay-150"></span><span class="animate-bounce inline-block w-2 h-2 bg-blue-400 rounded-full delay-300"></span><span class="ml-2 text-gray-500">AI is typing...</span></div>`;
                chatMessages.appendChild(typingDiv);
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }
            function removeTypingIndicator() {
                if (typingDiv && typingDiv.parentNode) {
                    typingDiv.parentNode.removeChild(typingDiv);
                    typingDiv = null;
                }
            }

            // Call Gemini API
            async function fetchGeminiReply(userMsg) {
                const prompt = `Based on the current temperature ${currentTemperature} ${userMsg}`;
                const body = JSON.stringify({
                    contents: [{ parts: [{ text: prompt }] }]
                });
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${GEMINI_API_KEY}`,
                    {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body
                    }
                );
                if (!response.ok) throw new Error('Gemini API error');
                const data = await response.json();
                // Parse Gemini response
                let aiText = 'AI did not return a message.';
                if (data && data.candidates && data.candidates[0] && data.candidates[0].content && data.candidates[0].content.parts && data.candidates[0].content.parts[0].text) {
                    aiText = data.candidates[0].content.parts[0].text;
                }
                return aiText;
            }
        });
    </script>
</body>
</html>
